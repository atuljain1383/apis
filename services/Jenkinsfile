pipeline{
    agent any
    stages{
        stage("Checkout"){
            steps{
                git credentialsId: 'GitHub', url: 'https://github.com/atuljain1383/apis.git'
            }
        }
        stage("Build"){
            steps{
                echo 'build started...'
            }
        }
        stage("Create images"){
            steps{
                sh "sudo docker-compose -f /var/lib/jenkins/workspace/Microservices/services/docker-compose.yml build"
            }
        }
        stage('Push Docker Image'){
           steps{
               withCredentials([string(credentialsId: 'dockerHubpwd', variable: 'dockerHubpwd')]) {
               sh "sudo docker login -u atuljain1383 -p ${dockerHubpwd}"
               sh 'sudo docker-compose -f /var/lib/jenkins/workspace/Microservices/services/docker-compose.yml push'
             }              
           }
        stage("Run container on DEV"){
            steps{
                def dockerCompose = "sudo docker-compose -f /var/lib/jenkins/workspace/Microservices/services/docker-compose.yml up"
                sshagent(['MServer2']) {
                   sh "ssh -o StrictHostKeyChecking=no ubuntu@172.31.11.14 ${dockerCompose}"
                }
            }
        }     
        }        
    }

}